# Exercise 1 - Getting Familiar with APIs
### V1 Date: 05/2020
### V2 Date: 03/2021



# Setup & Examine the lab environment
## Configure Environment Variables
To make life easier we will configure some environment variables.
The variables' values are dedicated for each participant and are provided by the instructor.

```bash
echo "export OCP_USERNAME=" >> ~/environ.sh
echo "export OCP_PASSWORD=openshift" >> ~/environ.sh
echo "export API_USERNAME=" >> ~/environ.sh
echo "export API_PASSWORD=admin" >> ~/environ.sh
echo "export OCP_CONSOLE_URL=" >> ~/environ.sh
echo "export OCP_API_URL=" >> ~/environ.sh

# Your user-corresponding 3scale tenant's api, without "https://" prefeix
echo "export API_URL=" >> ~/environ.sh
echo "export API_NAMESPACE=3scale-api0" >> ~/environ.sh
echo "export OCP_WILDCARD_DOMAIN=" >> ~/environ.sh

# After you fill the proper value for each variable
source ~/environ.sh
done
```
<p align="center">
  <img src="https://user-images.githubusercontent.com/60185557/114383956-cd7f3e00-9b96-11eb-9903-b2b5f30f39b5.png">
</p>

## Examine 3scale Namespace
Login to the cluster and examine the 3scale services

```bash
oc login -u ${OCP_USERNAME} -p ${OCP_PASSWORD} ${OCP_API_URL}
```
<p align="center">
  <img src="https://user-images.githubusercontent.com/60185557/114384917-01a72e80-9b98-11eb-9ed2-163ba5a7a56d.png">
</p>

```bash
oc get svc -n ${API_NAMESPACE}
oc get svc -n  ${OCP_USERNAME}-gw
```

Notice the APIcast Staging and APIcast Production services, they will help us later on to expose the APIs behind 3scale.
Also notice the zync service, this is the service that syncs between 3scale and RH-SSO.
* Each user OIDC application generated by 3scale will be added as client application to RH-SSO

# REST API application
We are going to deploy two REST API applications to see how 3scale can be an API Gateway, Load balancer, Filter tool etc for multiple backends simultaneously.

## Deploy App 1
```bash
oc new-project $OCP_USERNAME-coolstore
mkdir -p $HOME/lab

cat > $HOME/lab/app-config.yaml << EOF
catalog.http.port: 8080
connection_string: mongodb://catalog-mongodb:27017
db_name: catalogdb
username: mongo
password: mongo
EOF

oc create configmap app-config --from-file=$HOME/lab/app-config.yaml -n $OCP_USERNAME-coolstore

oc policy add-role-to-user view -z default -n $OCP_USERNAME-coolstore

oc create -f \
https://raw.githubusercontent.com/tommeramber/3scale_workshop_materials/master/coolstore-catalog-mongodb-persistent.yaml \
-n $OCP_USERNAME-coolstore

oc new-app \
        --template=coolstore-catalog-mongodb \
        -p CATALOG_DB_USERNAME=mongo \
        -p CATALOG_DB_PASSWORD=mongo \
        -n $OCP_USERNAME-coolstore

oc get pods -w -n $OCP_USERNAME-coolstore
```

**Wait until the DB’s pod (catalog-mongodb-1-XXXX) is ready with "1/1 Running", and then resume the app service (which depends on the DB to be up to work correctly).**

```bash
oc rollout resume deployment/catalog-service -n $OCP_USERNAME-coolstore

oc get pods -w

# Once the MongoDB & Catalog Service pods are running, run a cleanup

for p in `oc get pod | grep Complete | awk '{print $1}'` ; do oc delete pod $p ; done
```

After the service pods are up and running, extract the swagger of the app and examine its methods with a [Swagger Editor](https://editor.swagger.io/)

```bash
curl -k http://`oc get route -n $OCP_USERNAME-coolstore  catalog-unsecured --template {{.spec.host}}`/docs/coolstore-catalog-microservice-swagger.yaml > $HOME/lab/catalog-swagger.yaml

$ cat $HOME/lab/catalog-swagger.yaml 

# OR using vscode
# code $HOME/lab/catalog-swagger.yaml
```

Test the access to the app API:
```bash
echo http://`oc get route -n $OCP_USERNAME-coolstore catalog-unsecured --template {{.spec.host}}`
# Open the  link in the browser
```

<p align="center">
  <img src="https://user-images.githubusercontent.com/60185557/114385678-f99bbe80-9b98-11eb-9d6b-99ec0979f294.png">
</p>

## Deploy App 2
```bash
cat > $HOME/lab/inventory-config.yaml << EOF
swarm:
  datasources:
    data-sources:
      InventoryDS:
        driver-name: postgresql
        connection-url: jdbc:postgresql://inventory-postgresql:5432/inventorydb
        user-name: jboss
        password: jboss
EOF

oc create configmap inventory-config --from-file=$HOME/lab/inventory-config.yaml -n ${OCP_USERNAME}-coolstore

oc create -f https://raw.githubusercontent.com/tommeramber/3scale_workshop_materials/master/coolstore-inventory-persistent.yaml -n $OCP_USERNAME-coolstore

oc new-app \
    --template=coolstore-inventory-postgresql \
    -p INVENTORY_SERVICE_NAME=inventory-service \
    -p INVENTORY_DB_USERNAME=jboss \
    -p INVENTORY_DB_PASSWORD=jboss \
    -p INVENTORY_DB_NAME=inventorydb

oc get pods -w 
```

Wait until the DB’s pod (inventory-postgresql-1-XXXX) is ready with "1/1 Running", and then resume the app service (which depends on the DB to be up to work correctly):

```bash
oc rollout resume deploy/inventory-service -n $OCP_USERNAME-coolstore

oc get pods -w

# Once the Postgresql & Inventory Service pods are running, run a cleanup
for p in `oc get pod | grep Complete | awk '{print $1}'` ; do oc delete pod $p ; done
```

After the service pods are up and running, extract the swagger of the app and examine its methods with a [Swagger Editor](https://editor.swagger.io/)

```bash
curl -k -X GET http://`oc get route -n $OCP_USERNAME-coolstore  inventory-unsecured --template {{.spec.host}}`/swagger.json > $HOME/lab/inventory-swagger.json

cat $HOME/lab/inventory-swagger.json | jq
```

Test the access to the app API:

```bash
curl -ks -X GET http://`oc get route -n $OCP_USERNAME-coolstore  inventory-unsecured --template {{.spec.host}}`/inventory/165613 | python -m json.tool

curl -ks -X GET http://`oc get route -n $OCP_USERNAME-coolstore  inventory-unsecured --template {{.spec.host}}`/inventory/329299 | python -m json.tool
```


<p align="center">
  <img src="https://user-images.githubusercontent.com/60185557/114386145-847cb900-9b99-11eb-9c9d-901220ed75ca.png">
</p>

The following are the valid product IDs seeded for this POC, which you can use to try sample requests for the catalog and inventory APIs:
* 329299
* 329199
* 165613
* 165954
* 444434
* 444435
* 444436

```bash
cat > $HOME/lab/inventory-api-test.sh << EOF
#!/bin/bash

IDS="329299
329199
165613
165954
444434
444435
444436"

for i in \$IDS
do
 curl -ks -X GET http://\`oc get route -n $OCP_USERNAME-coolstore  inventory-unsecured --template {{.spec.host}}\`/inventory/\$i | python -m json.tool
done
EOF

sh $HOME/lab/inventory-api-test.sh
```

You can now view the routes exposed for each service:

```bash
oc get route -n $OCP_USERNAME-coolstore
```

Later on we will see how to expose the apps via the API Gateway (APIcast) so for now just remove these routes - so that the only way to access the services will be through the API Gateway.

```bash
oc delete route -n $OCP_USERNAME-coolstore catalog-unsecured
oc delete route -n $OCP_USERNAME-coolstore inventory-unsecured
oc get route -n $OCP_USERNAME-coolstore
```

**Desired output:**
*No resources found in ${USER}-coolstore namespace*
